name: MLOps â€“ Train, Build & Publish Image

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  mlops:
    runs-on: self-hosted   # ðŸ”´ CORRECTION CLÃ‰

    steps:
    # --------------------------------------------------
    # 1. Checkout
    # --------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # --------------------------------------------------
    # 2. Python setup
    # --------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    # --------------------------------------------------
    # 3. Install dependencies
    # --------------------------------------------------
    - name: Install dependencies
      working-directory: application
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install dvc[s3] mlflow

    # --------------------------------------------------
    # 4. Configure DVC (MinIO LOCAL)
    # --------------------------------------------------
    - name: Configure DVC MinIO (local)
      working-directory: application
      run: |
        dvc remote modify minio endpointurl http://localhost:9000
        dvc remote modify minio access_key_id "${{ secrets.MINIO_ACCESS_KEY }}"
        dvc remote modify minio secret_access_key "${{ secrets.MINIO_SECRET_KEY }}"
        dvc remote modify minio use_ssl false

    # --------------------------------------------------
    # 5. Pull dataset from DVC
    # --------------------------------------------------
    - name: DVC pull
      working-directory: application
      run: dvc pull

    # --------------------------------------------------
    # 6. Run preprocessing
    # --------------------------------------------------
    - name: Run preprocessing
      working-directory: application
      run: |
        python src/data_ingestion/youtube_comments/main.py
        python src/scripts/main.py

        dvc add data/cleaned_dataset.csv
        git add data/cleaned_dataset.csv.dvc
        git commit -m "Update cleaned dataset" || echo "No dataset changes"
        dvc push

    # --------------------------------------------------
    # 7. Train model
    # --------------------------------------------------
    - name: Train model
      working-directory: application
      run: python src/models/train_model.py

    # --------------------------------------------------
    # 8. Track trained model with DVC
    # --------------------------------------------------
    - name: Track model with DVC
      working-directory: application
      run: |
        dvc add src/models/emotion_classifier_pipe_lr.pkl
        git add src/models/emotion_classifier_pipe_lr.pkl.dvc
        git commit -m "Update trained model" || echo "No model changes"
        dvc push

    # --------------------------------------------------
    # 9. Build Docker image
    # --------------------------------------------------
    - name: Build Docker image
      run: docker build -t emotion-app .

    # --------------------------------------------------
    # 10. Push Docker image to Nexus
    # --------------------------------------------------
    - name: Push Docker image to Nexus
      run: |
        docker login ${{ secrets.NEXUS_HOST }} \
          -u ${{ secrets.NEXUS_USER }} \
          -p ${{ secrets.NEXUS_PASSWORD }}

        docker tag emotion-app \
          ${{ secrets.NEXUS_HOST }}/emotion-app:latest

        docker push \
          ${{ secrets.NEXUS_HOST }}/emotion-app:latest
