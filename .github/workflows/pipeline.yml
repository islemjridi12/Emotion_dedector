name: MLOps – Train, Build & Publish Image
on:
  push:
    branches:
      - master
  schedule:
    - cron: "0 2 * * 1"  # Every Monday at 02:00
  workflow_dispatch:
jobs:
  mlops:
    runs-on: self-hosted
    steps:
    # --------------------------------------------------
    # 1. Checkout
    # --------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v3
    # --------------------------------------------------
    # 1.1 Configure Git identity
    # --------------------------------------------------
    - name: Configure git identity
      shell: powershell
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"
    # --------------------------------------------------
    # 2. Check Python
    # --------------------------------------------------
    - name: Check Python version
      shell: powershell
      run: python --version
    # --------------------------------------------------
    # 3. Install dependencies
    # --------------------------------------------------
    - name: Install dependencies
      working-directory: application
      shell: powershell
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install dvc[s3] mlflow
    # --------------------------------------------------
    # 4. Configure DVC (MinIO LOCAL)
    # --------------------------------------------------
    - name: Configure DVC MinIO (local)
      working-directory: application
      shell: powershell
      run: |
        dvc remote modify minio endpointurl http://localhost:9000
        dvc remote modify minio access_key_id "${{ secrets.MINIO_ACCESS_KEY }}"
        dvc remote modify minio secret_access_key "${{ secrets.MINIO_SECRET_KEY }}"
        dvc remote modify minio use_ssl false
    # --------------------------------------------------
    # 5. Pull dataset from DVC
    # --------------------------------------------------
    - name: DVC pull
      working-directory: application
      shell: powershell
      run: dvc pull
    # --------------------------------------------------
    # 6. Preprocessing + track dataset
    # --------------------------------------------------
    - name: Run preprocessing
      working-directory: application
      shell: powershell
      run: |
        python src/data_ingestion/youtube_comments/main.py
        python src/scripts/main.py
        dvc add data/cleaned_dataset.csv
        git add data/cleaned_dataset.csv.dvc
        git commit -m "Update cleaned dataset"
        if (-not $?) { Write-Host "No dataset changes" }
        dvc push
    # --------------------------------------------------
    # 7. Train model
    # --------------------------------------------------
    - name: Train model
      working-directory: application
      shell: powershell
      run: python src/models/train_model.py
    # --------------------------------------------------
    # 8. Track trained model with DVC
    # --------------------------------------------------
    - name: Track trained model with DVC
      working-directory: application
      shell: powershell
      run: |
        dvc add src/models/emotion_classifier_pipe_lr.pkl
        git add src/models/emotion_classifier_pipe_lr.pkl.dvc
        git commit -m "Update trained model"
        if (-not $?) { Write-Host "No model changes" }
        dvc push
    # --------------------------------------------------
    # 9. Compare model performance (F1-score)
    # --------------------------------------------------
    - name: Compare model performance
      id: compare
      working-directory: application
      shell: powershell
      run: |
        $new = (Get-Content metrics.json | ConvertFrom-Json).f1_score
        git checkout HEAD~1 -- metrics.json.dvc
        dvc pull
        $old = (Get-Content metrics.json | ConvertFrom-Json).f1_score
        Write-Host "Old F1: $old"
        Write-Host "New F1: $new"
        if ($new -gt ($old + 0.01)) {
          Write-Host "Model improved → build allowed"
          echo "build=true" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "Model NOT improved → build skipped"
          echo "build=false" >> $env:GITHUB_OUTPUT
        }
        git checkout -- metrics.json.dvc
    # --------------------------------------------------
    # 10. Build Docker image (CONDITIONAL)
    # --------------------------------------------------
    - name: Build Docker image
      if: steps.compare.outputs.build == 'true'
      working-directory: application
      shell: powershell
      run: |
        docker build `
          -t emotion-app `
          -f docker/Dockerfile `
          .
    # --------------------------------------------------
    # 11. Push Docker image to Nexus (CONDITIONAL)
    # --------------------------------------------------
    - name: Push Docker image to Nexus (LOCAL)
      if: steps.compare.outputs.build == 'true'
      shell: powershell
      run: |
        echo "${{ secrets.NEXUS_PASSWORD }}" | docker login localhost:8091 `
          --username "${{ secrets.NEXUS_USER }}" `
          --password-stdin
        docker tag emotion-app localhost:5000/emotion-app:${{ github.sha }}
        docker push localhost:5000/emotion-app:${{ github.sha }}